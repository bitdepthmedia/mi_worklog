<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <style>
    :root { --bg:#fafbfc; --fg:#111; --muted:#666; --pri:#1a73e8; --border:#e5e7eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    .wrap { padding: 14px 14px 18px; background: var(--bg); color: var(--fg); }
    h2 { margin: 0 0 8px; font-size: 16px; }
    .field { margin: 8px 0 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], select, textarea { width:100%; box-sizing: border-box; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:13px; }
    .row { display:flex; gap:8px; }
    .row .field { flex:1; }
    .hint { font-size:11px; color:var(--muted); margin-top:4px; }
    button { background:var(--pri); color:#fff; border:none; padding:10px 12px; border-radius:6px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .footer { margin-top:12px; font-size:11px; color:var(--muted); }
    .error { color:#b00020; font-size:12px; margin:6px 0 0; }
    .success { color:#1b5e20; font-size:12px; margin:6px 0 0; }
    .stack { display:flex; flex-direction:column; gap:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Add Worklog Task</h2>
    <div class="stack">
      <div class="row">
        <div class="field">
          <label for="start">Start Time (HH:MM AM/PM)</label>
          <input id="start" type="text" placeholder="7:50 AM" autocomplete="off" />
        </div>
        <div class="field">
          <label for="end">End Time (HH:MM AM/PM)</label>
          <input id="end" type="text" placeholder="9:10 AM" autocomplete="off" />
        </div>
      </div>

      <div class="field">
        <label>What did you work on?</label>
        <select id="taskOption"></select>
        <div class="hint">Or type your own below</div>
        <input id="taskText" type="text" placeholder="e.g., Small group reading intervention" />
      </div>

      <div>
        <button id="submit">Add Task</button>
        <div class="error" id="error" hidden></div>
        <div class="success" id="success" hidden></div>
      </div>
      <div class="footer">Tasks post to todayâ€™s weekday; entries auto-sort by start time.</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const timePattern = /^(0?[1-9]|1[0-2]):([0-5][0-9])\s?(AM|PM)$/i;

    function setBusy(b){ $('submit').disabled = !!b; }
    function showError(msg){ const el=$('error'); el.textContent=msg||''; el.hidden=!msg; $('success').hidden=true; }
    function showSuccess(msg){ const el=$('success'); el.textContent=msg||''; el.hidden=!msg; $('error').hidden=true; }

    // Populate dropdown from server-injected template data
    (function init(){
      var options = <?!= JSON.stringify(taskOptions) ?>;
      const sel = $('taskOption');
      sel.innerHTML = '';
      options.forEach(o=>{
        const opt = document.createElement('option');
        opt.value = o; opt.textContent = o; sel.appendChild(opt);
      });
    }());

    $('submit').addEventListener('click', function(){
      showError(''); showSuccess('');
      const start = $('start').value.trim();
      const end = $('end').value.trim();
      const taskText = $('taskText').value.trim();
      const taskOption = $('taskOption').value;

      if (!timePattern.test(start)) return showError('Start time must be HH:MM AM/PM');
      if (!timePattern.test(end)) return showError('End time must be HH:MM AM/PM');
      if (!taskText && !taskOption) return showError('Please choose or enter a task');

      setBusy(true);
      google.script.run.withSuccessHandler(function(res){
        setBusy(false);
        if (!res || !res.ok) return showError(res && res.message || 'Failed to add task.');
        showSuccess(res.message + ' (Row ' + (res.placedRow||'?') + ')');
        // Keep inputs for quick next entry; optionally clear taskText
        $('taskText').value='';
      }).withFailureHandler(function(err){
        setBusy(false); showError(err && err.message || String(err));
      }).addTask({ startTime:start, endTime:end, taskOption:taskOption, taskText:taskText });
    });
  </script>
</body>
</html>
