<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <style>
    :root { --bg:#fafbfc; --fg:#111; --muted:#666; --pri:#1a73e8; --border:#e5e7eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    .wrap { padding: 14px 14px 18px; background: var(--bg); color: var(--fg); }
    h2 { margin: 0 0 8px; font-size: 16px; }
    .field { margin: 8px 0 12px; }
    label { display:block; font-size: 13px; color: #3000bf; margin-bottom: 6px; }
    input[type="text"], select, textarea { width:100%; box-sizing: border-box; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:13px; }
    .row { display:flex; gap:8px; }
    .row .field { flex:1; }
    .hint { font-size:11px; color:var(--muted); margin-top:4px; }
    .hintBold {font-size:12px;; color:#c77100}
    button { background:var(--pri); color:#fff; border:none; padding:10px 12px; border-radius:6px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .footer { margin-top:15px; font-size:11px; color:var(--muted); }
    .error { color:#b00020; font-size:18px; margin:6px 0 0; }
    .success { color:#1b5e20; font-size:18px; margin:6px 0 0; }
    .stack { display:flex; flex-direction:column; gap:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Add Worklog Task</h2>
    <div class="stack">
      <div class="field">
        <label for="dateOverride">Day/Date (optional)</label>
        <input id="dateOverride" type="date" />
        <div class="hint">Leave blank to use Today automatically.</div>
      </div>
      <div class="row">
        <div class="field">
          <label for="start">Start Time</label>
          <input id="start" type="time" autocomplete="off" />
        </div>
        <div class="field">
          <label for="end">End Time</label>
          <input id="end" type="time" autocomplete="off" />
        </div>
      </div>

      <div class="field">
        <label>What did you work on?</label>
        <select id="taskOption"></select>
        <div class="hintBold">Or type your own below</div>
        <input id="taskText" type="text" placeholder="e.g., Small group reading intervention" />
      </div>

      <div class="field" id="studentChooser">
        <label for="studentNames">Students (optional)</label>
        <div id="studentHelp" class="hint">If working with students, please select the student(s) or student group you worked with.</div>
        <div class="row">
          <div class="field">
            <label for="studentNames">Student Names</label>
            <select id="studentNames" multiple size="6" aria-describedby="studentHelp"></select>
          </div>
          <div class="field">
            <label for="studentGroup">Student Group</label>
            <select id="studentGroup" aria-describedby="studentHelp"></select>
          </div>
        </div>
        <div class="hint">Selecting names disables group, and vice-versa.</div>
      </div>

      <div class="field" id="grantField" hidden>
        <label for="grantSelect">Grant Source</label>
        <select id="grantSelect"></select>
        <div class="hint">Shown only when multiple grant sources exist.</div>
      </div>

      <div>
        <button id="submit">Add Task</button>
        <div class="error" id="error" hidden></div>
        <div class="success" id="success" hidden></div>
      </div>
      <div class="footer hintBold">Tasks post to todayâ€™s weekday unless a date is chosen; entries auto-sort by start time.</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const timePattern24 = /^([01]?\d|2[0-3]):([0-5]\d)$/;

    function setBusy(b){ $('submit').disabled = !!b; }
    function showError(msg){ const el=$('error'); el.textContent=msg||''; el.hidden=!msg; $('success').hidden=true; }
    function showSuccess(msg){ const el=$('success'); el.textContent=msg||''; el.hidden=!msg; $('error').hidden=true; }

    // Populate dropdown by fetching from server (avoids onOpen auth limits)
    (function init(){
      const sel = $('taskOption');
      sel.innerHTML = '';
      const setOptions = (options) => {
        sel.innerHTML = '';
        (options || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o; opt.textContent = o; sel.appendChild(opt);
        });
      };
      // Try load options; if fails, show minimal defaults
      google.script.run.withSuccessHandler(setOptions)
        .withFailureHandler(function(){ setOptions(['Lesson planning','Student support','Assessment','Data entry','Meeting']); })
        .getTaskOptions();

      // Load grant sources; show dropdown only when multiple exist
      const setGrantSources = (sources) => {
        const container = $('grantField');
        const gs = $('grantSelect');
        gs.innerHTML = '';
        if (Array.isArray(sources) && sources.length > 1) {
          sources.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s; gs.appendChild(opt);
          });
          container.hidden = false;
        } else {
          container.hidden = true;
        }
      };
      google.script.run.withSuccessHandler(setGrantSources)
        .withFailureHandler(function(){ setGrantSources([]); })
        .getGrantSources();

      // Load students and groups for optional student logging
      const namesEl = $('studentNames');
      const groupEl = $('studentGroup');
      const populateStudents = (res) => {
        // Students (multi-select)
        namesEl.innerHTML = '';
        (res && Array.isArray(res.students) ? res.students : []).forEach(function(s){
          const opt = document.createElement('option');
          opt.value = s.name; // value is name per spec; IDs resolved server-side
          opt.textContent = s.name;
          namesEl.appendChild(opt);
        });
        // Groups (single-select)
        groupEl.innerHTML = '';
        const blank = document.createElement('option'); blank.value = ''; blank.textContent = '';
        groupEl.appendChild(blank);
        (res && Array.isArray(res.groups) ? res.groups : []).forEach(function(g){
          if (!g) return;
          const opt = document.createElement('option');
          opt.value = g; opt.textContent = g;
          groupEl.appendChild(opt);
        });
      };
      google.script.run.withSuccessHandler(populateStudents)
        .withFailureHandler(function(){ populateStudents({students:[],groups:[]}); })
        .getActiveStudentsAndGroups();

      // Mutual exclusivity between names and group
      const clearNames = () => { Array.from(namesEl.options).forEach(o => o.selected = false); };
      const clearGroup = () => { groupEl.value = ''; };
      const updateLocks = () => {
        const anyNames = Array.from(namesEl.selectedOptions).length > 0;
        const hasGroup = !!groupEl.value;
        if (anyNames) { groupEl.disabled = true; } else { groupEl.disabled = false; }
        if (hasGroup) { namesEl.disabled = true; } else { namesEl.disabled = false; }
      };
      namesEl.addEventListener('change', function(){ if (Array.from(namesEl.selectedOptions).length) { clearGroup(); } updateLocks(); });
      groupEl.addEventListener('change', function(){ if (groupEl.value) { clearNames(); } updateLocks(); });
    }());

    $('submit').addEventListener('click', function(){
      showError(''); showSuccess('');
      const start = $('start').value.trim();
      const end = $('end').value.trim();
      const taskText = $('taskText').value.trim();
      const taskOption = $('taskOption').value;
      const dateOverride = $('dateOverride').value.trim(); // YYYY-MM-DD or ''

      if (!timePattern24.test(start)) return showError('Start time is required (HH:MM)');
      if (!timePattern24.test(end)) return showError('End time is required (HH:MM)');
      if (!taskText && !taskOption) return showError('Please choose or enter a task');

      setBusy(true);
      google.script.run.withSuccessHandler(function(res){
        setBusy(false);
        if (!res || !res.ok) return showError(res && res.message || 'Failed to add task.');
        showSuccess(res.message + ' (Row ' + (res.placedRow||'?') + ')');
        // Keep inputs for quick next entry; optionally clear taskText
        $('taskText').value='';
      }).withFailureHandler(function(err){
        setBusy(false); showError(err && err.message || String(err));
      }).addTask({
        startTime: start,
        endTime: end,
        taskOption: taskOption,
        taskText: taskText,
        dateOverride: dateOverride || null,
        grantSource: $('grantField').hidden ? null : ($('grantSelect').value || null),
        studentNames: Array.from($('studentNames').selectedOptions).map(o => o.value),
        studentGroup: $('studentGroup').disabled ? null : ($('studentGroup').value || null)
      });
    });
  </script>
</body>
</html>
